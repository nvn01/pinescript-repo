//@version=5
strategy("Bollinger Bands Mean Reversion Strategy", overlay=true, margin_long=100, margin_short=100, initial_capital=1000)

// Inputs
bbLength     = input.int(20, "BB Length", minval=1)
bbMult       = input.float(2.0, "BB Multiplier", minval=0.1)
src          = input.source(close, "Source")
risk_percent = input.float(1.0, "Risk per Trade (%)", minval=0.1, maxval=5)
atrLength    = input.int(14, "ATR Length", minval=1)
sl_mult      = input.float(2.0, "Stop Loss ATR Multiplier", minval=0.5)
tp_mult      = input.float(3.0, "Take Profit ATR Multiplier", minval=0.5)

// Bollinger Bands Calculation
basis       = ta.sma(src, bbLength)
dev         = bbMult * ta.stdev(src, bbLength)
upperBand   = basis + dev
lowerBand   = basis - dev
atrValue    = ta.atr(atrLength)

// Conditions
longCondition  = close < lowerBand
shortCondition = close > upperBand

// Variables for trade
var float entryPrice  = na
var float stopLoss    = na
var float takeProfit  = na

// Entry
if strategy.position_size == 0
    if longCondition
        entryPrice := close
        stopLoss   := entryPrice - (atrValue * sl_mult)
        takeProfit := entryPrice + (atrValue * tp_mult)
        qtySize    = (strategy.equity * risk_percent / 100) / (entryPrice - stopLoss)
        strategy.entry("Long", strategy.long, qty=qtySize)
        
    if shortCondition
        entryPrice := close
        stopLoss   := entryPrice + (atrValue * sl_mult)
        takeProfit := entryPrice - (atrValue * tp_mult)
        qtySize    = (strategy.equity * risk_percent / 100) / (stopLoss - entryPrice)
        strategy.entry("Short", strategy.short, qty=qtySize)

// Exit
if strategy.position_size > 0
    strategy.exit("Exit Long", "Long", stop=stopLoss, limit=takeProfit)
if strategy.position_size < 0
    strategy.exit("Exit Short", "Short", stop=stopLoss, limit=takeProfit)

// Plotting
plot(basis, color=color.yellow, title="BB Basis")
plot(upperBand, color=color.red, title="BB Upper")
plot(lowerBand, color=color.green, title="BB Lower")

bgcolor(strategy.position_size > 0 ? color.new(color.green, 90) : strategy.position_size < 0 ? color.new(color.red, 90) : na)

// Alerts
if longCondition
    alert("Long Signal - Price below Lower Bollinger Band", alert.freq_once_per_bar)
if shortCondition
    alert("Short Signal - Price above Upper Bollinger Band", alert.freq_once_per_bar)
