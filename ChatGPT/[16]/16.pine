//@version=5
strategy("SuperTrend + CCI + ATR Strategy", 
     overlay=true, 
     initial_capital=100000,
     default_qty_type=strategy.percent_of_equity, 
     default_qty_value=100)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ─── INPUTS ───────────────────────────────────────────────────────────────────
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
stAtrLength   = input.int(10,   "SuperTrend ATR Length", minval=1)
stMultiplier  = input.float(3.0,"SuperTrend Multiplier", minval=0.1, step=0.1)

// CCI
cciLength     = input.int(20,   "CCI Length", minval=1)
cciThreshold  = input.int(0,    "CCI Threshold", tooltip="Cross above/below this for entry")

// ATR for stops
atrPeriod     = input.int(14,   "ATR Period", minval=1)
slMultiplier  = input.float(1.5,"Stop-Loss Multiplier")
tpMultiplier  = input.float(2.0,"Take-Profit Multiplier")

useTakeProfit = input.bool(true, "Use ATR Take-Profit?")

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ─── CALCULATIONS ─────────────────────────────────────────────────────────────
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// 1) ── SUPERTREND CALCULATION ────────────────────────────────────────────────
//    We'll implement a common SuperTrend formula using ATR. The logic is:
//      * Calc 'basic bands' around the mid-price
//      * Track a 'direction' variable that flips from bullish to bearish
//        whenever price crosses a band.

atrValue = ta.atr(stAtrLength)
mPrice   = (high + low) / 2.0
upperBand = mPrice + stMultiplier * atrValue
lowerBand = mPrice - stMultiplier * atrValue

var float superTrend = na      // The current ST line
var bool  stIsBull   = true    // The current ST direction (true=up/bull, false=down/bear)

// On the very first bar, initialize with something
if barstate.isfirst
    superTrend := mPrice
    stIsBull   := close >= superTrend

// Each bar, we update the SuperTrend logic
superTrend_prev = superTrend[1]
stIsBull_prev   = stIsBull[1]

if stIsBull_prev
    // If old direction was bullish, the new upperBand might be lower
    // so SuperTrend is min of old superTrend and new upperBand
    superTrend := (upperBand < superTrend_prev) ? upperBand : superTrend_prev
    // If close < new superTrend => we flip to bear
    if close < superTrend
        stIsBull := false
        superTrend := lowerBand
else
    // If old direction was bearish, superTrend is max of old superTrend or lowerBand
    superTrend := (lowerBand > superTrend_prev) ? lowerBand : superTrend_prev
    // If close > new superTrend => flip to bull
    if close > superTrend
        stIsBull := true
        superTrend := upperBand

// 2) ── CCI CALCULATION ────────────────────────────────────────────────────────
//    We use the built-in Pine function: cci(source,length)
myCci = ta.cci(hlc3, cciLength)

// Signals:
//   * If superTrend is bullish & CCI crosses above some threshold => potential long
//   * If superTrend is bearish & CCI crosses below that threshold => potential short
bullSignal  = stIsBull and ta.crossover(myCci, cciThreshold)
bearSignal  = not stIsBull and ta.crossunder(myCci, cciThreshold)

// 3) ── ATR FOR RISK MGMT ─────────────────────────────────────────────────────
theAtr   = ta.atr(atrPeriod)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ─── ENTRY LOGIC ──────────────────────────────────────────────────────────────
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

if bullSignal
    // If we get a new bull signal but are short, close that position first
    if strategy.position_size < 0
        strategy.close_all("Reverse to Long")
    strategy.entry("Long", strategy.long)

if bearSignal
    // If new bear signal but are long, close out
    if strategy.position_size > 0
        strategy.close_all("Reverse to Short")
    strategy.entry("Short", strategy.short)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ─── STOP-LOSS & TAKE-PROFIT ─────────────────────────────────────────────────
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

longPosActive  = strategy.position_size > 0
shortPosActive = strategy.position_size < 0
entryPrice     = strategy.position_avg_price

if longPosActive
    longStop   = entryPrice - theAtr * slMultiplier
    longTarget = useTakeProfit ? (entryPrice + theAtr * tpMultiplier) : na
    strategy.exit("Exit Long", "Long", stop=longStop, limit=longTarget)

if shortPosActive
    shortStop   = entryPrice + theAtr * slMultiplier
    shortTarget = useTakeProfit ? (entryPrice - theAtr * tpMultiplier) : na
    strategy.exit("Exit Short", "Short", stop=shortStop, limit=shortTarget)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ─── PLOTTING (OPTIONAL) ──────────────────────────────────────────────────────
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// 1) SuperTrend line
plot(superTrend, color = stIsBull ? color.lime : color.red, linewidth=2, title="SuperTrend")

// (Optionally, show whether we are bullish/bearish via background color)
bgcolor(stIsBull ? color.new(color.teal, 90) : color.new(color.maroon, 90), title="ST Background")

// 2) CCI
plot(myCci, color=color.new(color.yellow, 0), title="CCI", offset=0, display=display.pane)
hline(cciThreshold, 'CCI Threshold', color=color.gray)

// 3) ATR debug
plot(theAtr, title="ATR (debug)", color=color.new(color.blue, 80), display=display.none)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ─── ALERTS (OPTIONAL) ────────────────────────────────────────────────────────
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
alertcondition(bullSignal, title="Bullish Setup", message="SuperTrend Bull + CCI Cross > Threshold")
alertcondition(bearSignal, title="Bearish Setup", message="SuperTrend Bear + CCI Cross < Threshold")
