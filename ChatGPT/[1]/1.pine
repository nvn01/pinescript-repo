//@version=4
strategy("EMA + MACD Strategy with Clear TP/SL", overlay=true, margin_long=100, margin_short=100)

// ----- INPUTS -----
// EMA
ema_len = input(50, minval=1, title="EMA Length")
ema = ema(close, ema_len)
plot(ema, title="EMA", color=color.blue)

// MACD
[macdLine, signalLine, _] = macd(close, 12, 26, 9)

// ATR
risk = input(title="Risk (%)", type=input.float, minval=0, defval=1) / 100
atr_bars = input(title="ATR Bars", defval=14, minval=1)
stop_mult = input(title="Stoploss Multiplicator", type=input.float, defval=2)
tp_mult = input(title="Takeprofit Multiplicator", type=input.float, defval=4)
tp1_mult = input(title="TP1 Multiplicator", type=input.float, defval=1.5)
tp2_mult = input(title="TP2 Multiplicator", type=input.float, defval=2.5)

atr = atr(atr_bars)

// ----- CONDITIONS -----
// Buy when MACD crosses above signal and price is above EMA
goLong = crossover(macdLine, signalLine) and close > ema

// Sell when MACD crosses below signal and price is below EMA
goShort = crossunder(macdLine, signalLine) and close < ema

// ------ GET IN/OUT A TRADE ------
inLongPosition = strategy.position_size > 0
inShortPosition = strategy.position_size < 0
notInTrade = strategy.position_size == 0

// ----- MANAGE TP/SL -----
float long_stop_level = na
float long_profit_level = na
long_stop_level := (goLong and notInTrade) ? close - atr * stop_mult : long_stop_level[1]
long_profit_level := (goLong and notInTrade) ? close + atr * tp_mult : long_profit_level[1]

float short_stop_level = na
float short_profit_level = na
short_stop_level := (goShort and notInTrade) ? close + atr * stop_mult : short_stop_level[1]
short_profit_level := (goShort and notInTrade) ? close - atr * tp_mult : short_profit_level[1]

// Execute buy or sell order
if goLong and notInTrade
    size = (strategy.equity * risk) / abs(close - long_stop_level)
    strategy.entry("Long", strategy.long, qty=size, alert_message="Entry Long")
else if goShort and notInTrade
    size = (strategy.equity * risk) / abs(close - short_stop_level)
    strategy.entry("Short", strategy.short, qty=size, alert_message="Entry Short")

// Set multiple takeprofit and the stoploss for long
long_sl = abs(strategy.position_avg_price - long_stop_level)
long_tp1 = tp1_mult * long_sl
long_tp2 = tp2_mult * long_sl
if inLongPosition
    strategy.exit("Take Profit 1", "Long", profit=long_tp1, stop=long_stop_level, alert_message="TP1 Long")
    strategy.exit("Take Profit 2", "Long", profit=long_tp2, stop=long_stop_level, alert_message="TP2 Long")
    
// Set multiple takeprofit and the stoploss for short
short_sl = abs(strategy.position_avg_price - short_stop_level)
short_tp1 = tp1_mult * short_sl
short_tp2 = tp2_mult * short_sl
if inShortPosition
    strategy.exit("Take Profit 1", "Short", profit=short_tp1, stop=short_stop_level, alert_message="TP1 Short")
    strategy.exit("Take Profit 2", "Short", profit=short_tp2, stop=short_stop_level, alert_message="TP2 Short")

// ----- Plot TP/SL -----
// Visualize the entry point, TP, and SL levels like the screenshot provided
entry_price_plot = plot(strategy.position_avg_price, color=color.white, linewidth=1, title="Entry Price")
p_long_sl = plot(long_stop_level, color=color.red, linewidth=1, title="Long Stop Loss")
p_long_tp = plot(long_profit_level, color=color.green, linewidth=1, title="Long Take Profit")
p_short_sl = plot(short_stop_level, color=color.red, linewidth=1, title="Short Stop Loss")
p_short_tp = plot(short_profit_level, color=color.green, linewidth=1, title="Short Take Profit")

// Highlight areas for TP/SL
fill(p_long_sl, entry_price_plot, color=color.red, title="Long SL Area", transp=90)
fill(p_long_tp, entry_price_plot, color=color.green, title="Long TP Area", transp=90)
fill(p_short_sl, entry_price_plot, color=color.red, title="Short SL Area", transp=90)
fill(p_short_tp, entry_price_plot, color=color.green, title="Short TP Area", transp=90)
